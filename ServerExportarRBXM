// server.js
// Servidor Node.js + Express para receber e hospedar arquivos .rbxmx
// Pode ser hospedado em: Vercel, Heroku, Railway, Render, etc.

const express = require('express');
const cors = require('cors');
const crypto = require('crypto');
const app = express();

// Middleware
app.use(cors());
app.use(express.json({ limit: '50mb' })); // Aceitar arquivos grandes

// Armazenamento em memÃ³ria (para produÃ§Ã£o use S3, Firebase, etc)
const fileStorage = new Map();

// PÃ¡gina inicial
app.get('/', (req, res) => {
    res.send(`
        <html>
        <head>
            <title>Roblox Studio Mobile - Export Server</title>
            <style>
                body { font-family: Arial; padding: 40px; background: #1a1a1a; color: white; }
                h1 { color: #00b0ff; }
                .stats { background: #2a2a2a; padding: 20px; border-radius: 10px; }
            </style>
        </head>
        <body>
            <h1>ğŸ“¦ Roblox Studio Mobile - Export Server</h1>
            <div class="stats">
                <h2>âœ… Servidor Online!</h2>
                <p>Arquivos armazenados: ${fileStorage.size}</p>
                <p>Endpoint: POST /api/export</p>
                <p>Download: GET /download/:fileId</p>
            </div>
        </body>
        </html>
    `);
});

// Endpoint para receber exports do Roblox
app.post('/api/export', (req, res) => {
    try {
        const { filename, type, content, timestamp, platform } = req.body;
        
        // ValidaÃ§Ã£o
        if (!filename || !content) {
            return res.status(400).json({
                success: false,
                error: 'Filename e content sÃ£o obrigatÃ³rios'
            });
        }
        
        // Gerar ID Ãºnico
        const fileId = crypto.randomBytes(16).toString('hex');
        
        // Salvar arquivo
        fileStorage.set(fileId, {
            filename,
            type,
            content,
            timestamp: timestamp || Date.now(),
            platform: platform || 'unknown',
            downloads: 0
        });
        
        // URL de download
        const downloadUrl = `${req.protocol}://${req.get('host')}/download/${fileId}`;
        
        console.log(`âœ… Arquivo recebido: ${filename} (${type}) - ID: ${fileId} - Plataforma: ${platform}`);
        
        res.json({
            success: true,
            fileId,
            downloadUrl,
            message: 'Arquivo pronto para download!'
        });
        
        // Limpar arquivo apÃ³s 24 horas (opcional)
        setTimeout(() => {
            if (fileStorage.has(fileId)) {
                fileStorage.delete(fileId);
                console.log(`ğŸ—‘ï¸ Arquivo ${fileId} deletado apÃ³s 24h`);
            }
        }, 24 * 60 * 60 * 1000);
        
    } catch (error) {
        console.error('âŒ Erro ao processar upload:', error);
        res.status(500).json({
            success: false,
            error: error.message
        });
    }
});

// Endpoint para baixar arquivo
app.get('/download/:fileId', (req, res) => {
    const { fileId } = req.params;
    
    if (!fileStorage.has(fileId)) {
        return res.status(404).send(`
            <html>
            <body style="font-family: Arial; padding: 40px; background: #1a1a1a; color: white;">
                <h1>âŒ Arquivo nÃ£o encontrado</h1>
                <p>O arquivo pode ter expirado ou o ID estÃ¡ incorreto.</p>
            </body>
            </html>
        `);
    }
    
    const file = fileStorage.get(fileId);
    file.downloads++;
    
    // Headers para forÃ§ar download
    res.setHeader('Content-Type', 'application/xml');
    res.setHeader('Content-Disposition', `attachment; filename="${file.filename}"`);
    res.setHeader('Access-Control-Allow-Origin', '*');
    
    console.log(`ğŸ“¥ Download: ${file.filename} - Total: ${file.downloads}x`);
    
    res.send(file.content);
});

// PÃ¡gina de preview (opcional - para ver o XML)
app.get('/preview/:fileId', (req, res) => {
    const { fileId } = req.params;
    
    if (!fileStorage.has(fileId)) {
        return res.status(404).send('<h1>Arquivo nÃ£o encontrado</h1>');
    }
    
    const file = fileStorage.get(fileId);
    
    res.send(`
        <html>
        <head>
            <title>${file.filename} - Preview</title>
            <style>
                body { font-family: 'Courier New'; padding: 20px; background: #1a1a1a; color: #0f0; }
                pre { white-space: pre-wrap; word-wrap: break-word; }
                .header { background: #2a2a2a; padding: 20px; margin-bottom: 20px; border-radius: 10px; }
                .download-btn { 
                    display: inline-block;
                    background: #00b0ff;
                    color: white;
                    padding: 10px 20px;
                    text-decoration: none;
                    border-radius: 5px;
                    margin-top: 10px;
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>ğŸ“„ ${file.filename}</h1>
                <p>Tipo: ${file.type}</p>
                <p>Plataforma: ${file.platform}</p>
                <p>Downloads: ${file.downloads}</p>
                <a href="/download/${fileId}" class="download-btn">ğŸ“¥ Baixar Arquivo</a>
            </div>
            <h2>Preview do XML:</h2>
            <pre>${escapeHtml(file.content)}</pre>
        </body>
        </html>
    `);
});

// EstatÃ­sticas
app.get('/api/stats', (req, res) => {
    const stats = {
        totalFiles: fileStorage.size,
        files: Array.from(fileStorage.entries()).map(([id, file]) => ({
            id,
            filename: file.filename,
            type: file.type,
            platform: file.platform,
            downloads: file.downloads,
            timestamp: file.timestamp
        }))
    };
    
    res.json(stats);
});

// FunÃ§Ã£o auxiliar para escapar HTML
function escapeHtml(text) {
    return text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
}

// Iniciar servidor
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
    console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   ğŸš€ Servidor Export Online!              â•‘
â•‘   ğŸ“¡ Porta: ${PORT}                        â•‘
â•‘   ğŸŒ http://localhost:${PORT}             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    `);
});

// Export para Vercel/Serverless
module.exports = app;
